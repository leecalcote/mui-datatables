import React from 'react';
import { spy, stub } from 'sinon';
import { mount, shallow } from 'enzyme';
import { assert } from 'chai';
import getTextLabels from '../src/textLabels';
import TableHeadCell from '../src/components/TableHeadCell';
import TableCell from '@mui/material/TableCell';
import TableSortLabel from '@mui/material/TableSortLabel';
import HelpIcon from '@mui/icons-material/Help';
import { DndContext } from '@dnd-kit/core';

describe('<TableHeadCell />', function() {
  let classes;

  before(() => {
    classes = {
      root: {},
    };
  });

  it('should add custom props to header cell if "setCellHeaderProps" provided', () => {
    const options = { sort: true, textLabels: getTextLabels() };
    const toggleSort = () => {};
    const setCellHeaderProps = { myProp: 'test', className: 'testClass' };
    const selectRowUpdate = stub();
    const toggleExpandRow = () => {};

    const mountWrapper = mount(
      <DndContext>
        <TableHeadCell
          cellHeaderProps={setCellHeaderProps}
          options={options}
          sortDirection={'asc'}
          sort={true}
          toggleSort={toggleSort}
          classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    );

    const props = mountWrapper.find(TableCell).props();
    const classNames = props.className.split(' ');
    const finalClass = classNames[classNames.length - 1];

    assert.strictEqual(props.myProp, 'test');
    assert.strictEqual(finalClass, 'testClass');
  });

  it('should render a table head cell with sort label when options.sort = true provided', () => {
    const options = { sort: true, textLabels: getTextLabels() };
    const toggleSort = () => {};

    const wrapper = mount(
      <DndContext>
        <TableHeadCell options={options} sortDirection={'asc'} sort={true} toggleSort={toggleSort} classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    );

    const actualResult = wrapper.find(TableSortLabel);
    assert.strictEqual(actualResult.length, 1);
  });

  it('should render a table head cell without sort label when options.sort = false provided', () => {
    const options = { sort: false, textLabels: getTextLabels() };
    const toggleSort = () => {};

    const shallowWrapper = shallow(
      <DndContext>
        <TableHeadCell options={options} sortDirection={'asc'} sort={true} toggleSort={toggleSort} classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    );

    const actualResult = shallowWrapper.find(TableSortLabel);
    assert.strictEqual(actualResult.length, 0);
  });

  it('should render a table help icon when hint provided', () => {
    const options = { sort: true, textLabels: getTextLabels() };

    const wrapper = mount(
      <DndContext>
        <TableHeadCell options={options} hint={'hint text'} classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    );

    const actualResult = wrapper.find(HelpIcon);
    assert.strictEqual(actualResult.length, 1);
  });

  it('should render a table head cell without custom tooltip when hint provided', () => {
    const options = { sort: true, textLabels: getTextLabels() };

    const shallowWrapper = shallow(
      <DndContext>
        <TableHeadCell options={options} classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    ).dive();

    const actualResult = shallowWrapper.find(HelpIcon);
    assert.strictEqual(actualResult.length, 0);
  });

  it('should trigger toggleSort prop callback when calling method handleSortClick', () => {
    const options = { sort: true, textLabels: getTextLabels() };
    const toggleSort = spy();

    const wrapper = mount(
      <DndContext>
        <TableHeadCell
          options={options}
          sort={true}
          index={0}
          sortDirection={'asc'}
          toggleSort={toggleSort}
          classes={classes}>
          some content
        </TableHeadCell>
      </DndContext>,
    );

    // Find the button with data-testid
    const btn = wrapper.find('[data-testid="headcol-0"]').at(0);
    if (btn.length > 0 && btn.prop('onClick')) {
      btn.prop('onClick')({ preventDefault: () => {} });
    } else {
      const instance = wrapper
        .find('td')
        .at(0)
        .childAt(0);
      instance.simulate('click');
    }
    wrapper.update();

    assert.strictEqual(toggleSort.callCount, 1);
  });
});
